name: Auto Code Rover POC

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  auto-code-rover:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Checkout POC repository
        uses: actions/checkout@v4

      - name: Clone auto-code-rover
        run: |
          git clone https://github.com/nus-apr/auto-code-rover.git auto-code-rover
          cd auto-code-rover
          echo "Auto-code-rover cloned successfully"
          ls -la

      - name: Patch auto-code-rover to support Claude 3.5 Haiku
        run: |
          cd auto-code-rover

          # Add Claude3_5Haiku class to claude.py
          printf '\n\nclass Claude3_5Haiku(AnthropicModel):\n    def __init__(self):\n        super().__init__(\n            "claude-3-5-haiku-20241022", 0.0000008, 0.000004, parallel_tool_call=True\n        )\n        self.note = "Fastest and most cost-effective model from Anthropic"\n' >> app/model/claude.py

          # Register the new model in register.py (add after Claude3_5SonnetNew)
          sed -i 's/common\.register_model(claude\.Claude3_5SonnetNew())/&\n    common.register_model(claude.Claude3_5Haiku())/' app/model/register.py

          echo "âœ… Patched auto-code-rover to support claude-3-5-haiku-20241022"

          # Verify the patch
          echo "--- Verifying claude.py ---"
          tail -10 app/model/claude.py
          echo "--- Verifying register.py ---"
          grep "Claude3_5" app/model/register.py || echo "Pattern not found"

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          environment-file: auto-code-rover/environment.yml
          activate-environment: auto-code-rover
          python-version: 3.12
          auto-update-conda: false
          auto-activate-base: false

      - name: Verify conda environment
        run: |
          conda info
          conda list

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE/auto-code-rover" >> $GITHUB_ENV

      - name: Display environment for debugging
        run: |
          echo "=== Environment Variables ==="
          echo "ANTHROPIC_API_KEY is set: ${{ secrets.ANTHROPIC_API_KEY != '' }}"
          echo "OPENAI_KEY is set: ${{ secrets.OPENAI_KEY != '' }}"
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue URL: ${{ github.event.issue.html_url }}"
          echo "Repository: ${{ github.repository }}"
          echo "Clone URL: ${{ github.event.repository.clone_url }}"
          echo "SHA: ${{ github.sha }}"
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la $GITHUB_WORKSPACE

      - name: Run auto-code-rover on issue
        run: |
          cd auto-code-rover

          # Use Anthropic API if available, otherwise OpenAI
          MODEL="gpt-4o-2024-05-13"
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            MODEL="claude-3-5-haiku-20241022"
          fi

          echo "Using model: $MODEL"

          # Run auto-code-rover
          python app/main.py github-issue \
            --output-dir output \
            --setup-dir setup \
            --model "$MODEL" \
            --model-temperature 0.2 \
            --task-id "issue-${{ github.event.issue.number }}" \
            --clone-link "${{ github.event.repository.clone_url }}" \
            --commit-hash "${{ github.sha }}" \
            --issue-link "${{ github.event.issue.html_url }}"

      - name: Upload output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-code-rover-output-${{ github.event.issue.number }}
          path: auto-code-rover/output/
          retention-days: 7

      - name: Upload setup artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-code-rover-setup-${{ github.event.issue.number }}
          path: auto-code-rover/setup/
          retention-days: 7

      - name: Comment results on issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = '## Auto-Code-Rover Execution Completed\n\n';
            comment += `- Task ID: issue-${{ github.event.issue.number }}\n`;
            comment += `- Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n`;
            comment += '\nCheck the workflow artifacts for detailed output.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
